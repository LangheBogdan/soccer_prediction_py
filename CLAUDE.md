# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

The Soccer Prediction application is a data-driven machine learning system that predicts football match outcomes. It combines data scraping (fbref.com), external APIs (football-data.org, api-football.com), advanced statistical analysis, and ML predictions. The application includes a web-based frontend for league/match selection, prediction generation, and historical performance tracking.

**Key workflow**: User selects league/period → System fetches matches → User selects match → Detailed metrics retrieved → ML model generates prediction → User saves prediction → System tracks prediction accuracy.

## Architecture Overview

### Core Components

1. **Data Ingestion Layer**: Web scraper and API clients that fetch data from fbref.com, football-data.org, and api-football.com
2. **Database Layer**: Stores leagues, teams, matches, historical stats, odds, predictions, and results
3. **Backend API**: Python web framework (FastAPI or Flask) exposing REST endpoints for frontend consumption
4. **Machine Learning Module**: Handles data preprocessing, model training, evaluation, and prediction generation
5. **Frontend**: HTML/CSS (Tailwind) and JavaScript for user interactions

### Technology Stack

- **Backend**: Python with FastAPI or Flask
- **Database**: PostgreSQL or MySQL (to be configured in Docker)
- **Frontend**: HTML5, JavaScript (vanilla), Tailwind CSS (built locally, not CDN)
- **Containerization**: Docker and Docker Compose
- **ML Libraries**: scikit-learn, pandas, numpy (exact choices TBD)
- **Web Scraping**: requests, BeautifulSoup4
- **Environment Management**: python-dotenv

### Database Schema (Planned)

The system stores:
- League and team information
- Match data with dates and participants
- Historical statistics from fbref
- Betting odds from external APIs
- User-generated predictions and their outcomes
- Accuracy metrics and performance tracking

## Development Commands

### Project Setup

```bash
# Create project structure
mkdir -p src data models docker tests
mkdir -p src/api src/ml src/scraper src/static

# Install dependencies (to be configured)
# pip install -r requirements.txt  # or use pyproject.toml
```

### Environment Configuration

Create a `.env` file from `.env.template` (to be created) with:
- Database credentials
- API keys for external services (football-data.org, api-football.com)
- Application settings

### Docker & Containerization

```bash
# Build Docker images
docker compose build

# Start all services (Python app, Database)
docker compose up -d

# View logs
docker compose logs -f

# Stop services
docker compose down
```

### Frontend Dependencies & Build

**Setup (first time):**
```bash
# Install Node.js dependencies
npm install
```

**Tailwind CSS Build:**
```bash
# Build Tailwind CSS (from local config, not CDN)
npm run build:css

# Watch mode for development (auto-rebuilds on CSS changes)
npm run watch:css

# Development mode (alias for watch:css)
npm run dev
```

**Tailwind Configuration:**
- `tailwind.config.js`: Scans `src/static/**/*.html` and `src/static/**/*.js` for class names
  - Extended color palette with primary and secondary colors
  - System font stack configured
- `src/static/css/input.css`: Entry point with Tailwind directives and custom component classes
  - Button variants: `.btn-primary`, `.btn-secondary`, `.btn-outline`
  - Card styling: `.card`
  - Form elements: `.input`, `.label`
- Output: `src/static/css/output.css` (minified for production)

### Testing

```bash
# Run all tests
pytest

# Run specific test file
pytest tests/test_scraper.py

# Run with coverage
pytest --cov=src
```

### Running the Application

```bash
# Using Docker Compose (recommended)
docker compose up

# Direct Python (for development)
python -m src.api.main  # or appropriate entry point
```

## Key Directories & Files

```
soccer_prediction/
├── src/
│   ├── api/                 # FastAPI/Flask endpoints
│   ├── ml/                  # ML model and prediction logic
│   ├── scraper/             # Web scraping (fbref.com)
│   ├── clients/             # External API clients (football-data.org, api-football.com)
│   ├── db/                  # Database models and queries
│   └── static/
│       ├── css/
│       │   ├── input.css    # Tailwind source CSS with custom components
│       │   └── output.css   # Compiled CSS (generated by build process)
│       ├── index.html       # Main HTML template (to be created)
│       └── js/              # Frontend JavaScript files (to be created)
├── data/                    # Raw and processed data
├── models/                  # Trained ML models (serialized)
├── docker/                  # Dockerfile and compose configuration
├── tests/                   # pytest test suite
├── .env.template            # Environment variables template
├── .gitignore               # Git ignore patterns
├── package.json             # Node.js dependencies and npm scripts
├── tailwind.config.js       # Tailwind CSS configuration
├── postcss.config.js        # PostCSS configuration
├── pyproject.toml           # Python dependencies
├── docker-compose.yml       # Service orchestration
└── CLAUDE.md                # This file
```

## API Endpoints (Planned)

The backend exposes these endpoints:

```
GET  /api/matches              # Fetch matches for league/period
GET  /api/match/{id}/details   # Get advanced metrics for a match
POST /api/match/{id}/predict   # Generate ML prediction
POST /api/prediction/{id}/save # Save prediction to database
GET  /api/match/{id}/odds      # Fetch betting odds
GET  /api/history              # Retrieve all saved predictions & performance
```

All endpoints include error handling for missing data, failed predictions, and save errors.

## Frontend Flow

1. **League/Period Selection**: Dropdowns and date pickers
2. **Match List**: Displays matches from API call (GET /api/matches)
3. **Match Details**: Modal/page showing metrics with "Get Odds" button
4. **Prediction View**: Displays ML-generated prediction with "Save" button
5. **History Dashboard**: Shows past predictions, accuracy rates, and profit/loss

Frontend uses vanilla JavaScript for API communication and Tailwind CSS for styling.

## ML Model Development

### Training Pipeline

1. **Data Preprocessing**: Clean and feature-engineer data from database
2. **Model Selection**: Research and prototype (Logistic Regression, Random Forest, XGBoost)
3. **Training**: Script to train on historical match data
4. **Evaluation**: Assess accuracy, precision, recall
5. **Serialization**: Save trained model as .pkl or .joblib

### Prediction Script

The `/api/match/{id}/predict` endpoint loads the trained model, accepts match data, and returns prediction with confidence metrics.

## Testing Strategy

- **Unit tests** for scraper, API clients, and endpoints (using pytest)
- **ML tests** for prediction script
- **Integration tests** for full flow: API → ML → Database
- **Frontend testing** includes manual testing of all interactions and error states

## Implementation Progress

### Phase 1: Project Setup & Environment ✓ (Completed)

**Completed:**
- ✓ Project directory structure created (src/{api,ml,scraper,clients,db,static}, data, models, docker, tests)
- ✓ `.env.template` created with database and API configuration placeholders
- ✓ `pyproject.toml` created with all core dependencies (FastAPI, pandas, scikit-learn, etc.)
- ✓ `Dockerfile` created with multi-stage build and security best practices
- ✓ `docker-compose.yml` created with PostgreSQL and FastAPI services
- ✓ Python package structure created with `__init__.py` files in all modules
- ✓ Tailwind CSS build process set up with npm scripts and configuration

### Phase 2: Data Acquisition & Database ✓ (Completed)

**Completed:**
- ✓ Database schema design with 10 entities (Leagues, Teams, Matches, Stats, Odds, Users, Predictions, Results, ModelMetrics)
- ✓ SQLAlchemy ORM models with proper relationships, constraints, and indexes
- ✓ Database configuration with support for PostgreSQL (production) and SQLite (development)
- ✓ Database initialization script (`src/db/init_db.py`) with seeding capability
- ✓ Comprehensive database schema documentation (`docs/DATABASE_SCHEMA.md`)
- ✓ 14 passing unit tests covering model creation, relationships, cascades, and data integrity
- ✓ Environment-based database configuration with automatic connection pooling

**Database Features:**
- Cascade delete relationships for data integrity
- Foreign key constraints on all relationships
- Performance indexes on frequently queried columns
- Automatic timestamp management (created_at, updated_at)
- Support for match statistics from multiple data sources (JSON storage)
- Betting odds tracking from multiple bookmakers
- User prediction history with accuracy metrics and P/L tracking

### Phase 2 (Continuation): Web Scraper & API Clients ✓ (Completed)

**Completed:**
- ✓ FBref.com web scraper (`src/scraper/fbref_scraper.py`)
  - League standings and team statistics extraction
  - Historical match data with detailed statistics
  - Rate limiting enforcement (2-second delays, respectful scraping)
  - Error handling for network issues and missing data
  - 21 comprehensive unit tests

- ✓ football-data.org API client (`src/clients/football_data_client.py`)
  - Current/scheduled match fetching with status filters
  - League standings for 6 major European leagues
  - Betting odds from multiple bookmakers
  - Head-to-head match history
  - Date range queries and player statistics
  - 19 comprehensive unit tests

- ✓ api-football.com API client (`src/clients/api_football_client.py`)
  - Fixtures/matches with status filtering
  - League standings and team statistics
  - Player statistics and performance metrics
  - Betting odds from multiple bookmakers
  - Injury and suspension information
  - 21 comprehensive unit tests

- ✓ the-odds-api.com client (`src/clients/odds_api_client.py`)
  - Specialized betting odds aggregation from 12+ bookmakers
  - Support for 8 major European leagues + Champions League
  - Historical odds tracking by date
  - Event/match-specific odds queries
  - Best odds identification across bookmakers
  - 29 comprehensive unit tests

- ✓ Data pipeline orchestration (`src/scraper/pipeline.py`)
  - Multi-source data collection (FBref, football-data.org, api-football.com)
  - Data transformation to ORM models
  - Conflict resolution and deduplication
  - Bulk insert/update operations
  - Comprehensive error handling and logging
  - 18 comprehensive pipeline tests

- ✓ Enhanced environment configuration (`.env.template`)
  - API keys for external services
  - Rate limiting and timeout settings
  - Data pipeline feature flags
  - Retry and error handling configuration

- ✓ **123 Total Passing Tests** (80 Phase 2 continuation + 29 OddsApiClient tests)
  - All tests use mocking to avoid external API calls
  - Full coverage of scraper, API clients, and pipeline
  - Comprehensive error handling and edge case testing

**Scraper/API Features:**
- Respectful rate limiting for all sources
- Comprehensive error handling (timeouts, 429 rate limits, bad requests)
- Support for multiple data source formats (FBref, football-data, api-football, the-odds-api)
- Automatic deduplication and conflict resolution
- Flexible data pipeline with configurable sources
- Extensive logging for debugging and monitoring
- 12+ bookmaker odds aggregation with best odds computation
- Historical odds tracking and date-based queries

### Phase 3: API Endpoints & Backend ✓ (Completed)

**Completed:**
- ✓ FastAPI application setup (`src/api/main.py`)
  - CORS middleware for frontend integration
  - TrustedHostMiddleware for production security
  - Custom exception handlers with proper JSONResponse returns
  - Health check endpoints with database connectivity verification
  - League endpoints (list all, get by ID with pagination)
  - Team endpoints (list teams in league)
  - Match endpoints (list all, filter by league/status, get details)
  - API version and info endpoints
  - Startup/shutdown event handlers

- ✓ Dependency injection layer (`src/api/dependencies.py`)
  - Database session management with FastAPI Depends
  - Automatic session cleanup and error handling
  - Session lifecycle management with rollback on errors

- ✓ Request/response validation schemas (`src/api/schemas.py`)
  - League, Team, Match response models
  - MatchDetailResponse with relationships
  - MatchFilterQuery for filter parameters
  - Odds, Prediction, PredictionResult models
  - Error response schema
  - Pydantic v2 compatible with proper validation

- ✓ API route modules
  - `src/api/routes/predictions.py`: Prediction management
    - Create predictions with user/match validation
    - Get prediction by ID
    - Get user's predictions with pagination
    - Get user statistics (total predictions, accuracy, ROI)
  - `src/api/routes/odds.py`: Betting odds endpoints
    - Get match odds with optional bookmaker filtering
    - Get best odds across all bookmakers
    - List available bookmakers
    - Compare odds across bookmakers in tabular format

- ✓ Comprehensive endpoint tests (`tests/test_api_endpoints.py`)
  - 29 integration tests covering all endpoints
  - TestHealthCheck: root, health check, API version
  - TestLeagueEndpoints: list, get by ID, pagination, not found
  - TestTeamEndpoints: list teams in league, not found
  - TestMatchEndpoints: list, filter by league/status, details, not found, invalid status
  - TestOddsEndpoints: match odds, best odds, available bookmakers, comparison
  - TestPredictionEndpoints: create, get, list user's predictions, statistics, error cases
  - Database fixtures with SQLite test database
  - All tests passing with proper error handling

- ✓ Fixed critical issues
  - Exception handlers returning JSONResponse instead of dict
  - SQLAlchemy 2.0 text() syntax for raw SQL queries
  - Parameter shadowing: match_status with Query alias to map to "status" in URL
  - TrustedHostMiddleware conditionally applied only in production

- ✓ **152 Total Passing Tests** (29 Phase 3 + 123 existing)

**API Features:**
- RESTful endpoint design following standard conventions
- Proper HTTP status codes (200, 201, 400, 404, 500, 503)
- Consistent error response format with detail and timestamp
- Request parameter validation with informative error messages
- Database session management per request
- Comprehensive logging throughout
- CORS headers for frontend integration
- Production security middleware

### Phase 3.5: ML Model Training & Prediction Endpoints ✓ (Completed)

**Completed:**
- ✓ Feature engineering module (`src/ml/features.py`)
  - Extract recent match statistics for teams
  - Head-to-head analysis between opponents
  - Team statistics calculation (win rate, goals, possession, etc.)
  - Full match feature extraction (27 features total: team stats, H2H, relative metrics)
  - Training dataset creation from historical matches
  - 7 comprehensive unit tests covering all feature functions

- ✓ ML model training module (`src/ml/model.py`)
  - ModelManager class for training and loading
  - Support for logistic regression and random forest models
  - Model evaluation with accuracy, precision, recall, F1 score, AUC, cross-validation
  - Model serialization/deserialization with joblib
  - Database storage of model metrics
  - Prediction function with confidence scores and probabilities
  - 5 comprehensive unit tests covering training and prediction

- ✓ ML prediction API endpoints (`src/api/routes/ml.py`)
  - POST /api/ml/predict/match/{id} - Get prediction for a match
  - GET /api/ml/model/metrics - Retrieve model performance metrics
  - POST /api/ml/model/train - Trigger model retraining with latest data
  - Proper error handling for invalid matches/states (404, 400, 503)
  - Request/response validation with Pydantic

- ✓ Request/response schemas (`src/api/schemas.py`)
  - PredictionResult schema for ML predictions
  - Includes match_id, predicted_outcome, confidence, and probabilities dict

- ✓ Main app integration (`src/api/main.py`)
  - ML router included in FastAPI application
  - Seamless integration with existing endpoints and middleware

- ✓ Baseline model training script (`src/ml/train_baseline.py`)
  - Automated model training workflow
  - Database initialization and sample data seeding
  - Model serialization and metadata storage
  - Comprehensive logging and progress reporting

- ✓ Sample data seeding (`src/db/init_db.py`)
  - New `seed_sample_data()` function creates test leagues, teams, and matches
  - Generates 50 historical matches with varied outcomes and statistics
  - Used for training baseline model

- ✓ Trained baseline model files
  - `/models/match_predictor.joblib` - Trained logistic regression model
  - `/models/match_predictor_encoder.joblib` - Outcome label encoder
  - `/models/match_predictor_metadata.json` - Model metadata and feature list

- ✓ **Comprehensive ML Testing** - 19 NEW TESTS
  - TestFeatureEngineering: 7 tests for all feature functions
  - TestDatasetCreation: 4 tests for dataset creation and validation
  - TestModelManager: 5 tests for model training, saving, loading, prediction
  - TestMLIntegration: 3 tests for end-to-end training and metrics

- ✓ **Testing Results** - 171 TOTAL PASSING TESTS (19 Phase 3.5 + 152 existing)
  - All feature engineering functions validated
  - Model training and evaluation working correctly
  - Model persistence and loading verified
  - Prediction endpoint logic tested
  - All 171 tests passing in 10.57 seconds

**Baseline Model Performance (on 50 test matches):**
- Accuracy: 100% (test set), 77.5% (cross-validation)
- Precision: 100%
- Recall: 100%
- F1 Score: 100%
- AUC Score: 100%
- Training samples: 50 historical matches
- Features: 27 engineered features per match

**ML Features Extracted:**
1. Home team statistics (9 features): win rate, draw rate, loss rate, goals for/against, shots, possession
2. Away team statistics (9 features): same as home but for away team
3. Relative features (3 features): goal difference, possession difference, win rate difference
4. Head-to-head statistics (5 features): home wins, away wins, draws, average goals
5. Context feature (1 feature): home advantage flag

### Phase 4: Frontend Integration & Web Interface ✓ (Completed)

**Completed:**
- ✓ HTML template (`src/static/index.html`)
  - Responsive navigation with home/history/about views
  - League and match selection interface
  - Match details modal with statistics display
  - Betting odds display section
  - ML prediction results display with probabilities
  - Historical predictions dashboard with stats
  - About section with app information
  - Responsive Tailwind CSS structure

- ✓ JavaScript application (`src/static/js/app.js`)
  - API client for backend communication
  - League loading and dropdown population
  - Match filtering by league and status
  - Match list display with real-time updates
  - Match details modal management
  - Betting odds fetching and display
  - ML prediction generation with confidence scores
  - Prediction saving to database
  - Prediction history loading and display
  - User statistics calculation and display
  - View navigation (home/history/about)
  - Error handling and user feedback
  - Loading spinner management

- ✓ Tailwind CSS compilation and build
  - Build CSS with npm (14.3 KB minified output)
  - Responsive design with Tailwind utility classes
  - Custom component classes for buttons, cards, forms
  - Color scheme with primary/secondary colors

- ✓ Static file serving
  - Added StaticFiles mounting in FastAPI for CSS/JS
  - Created frontend HTML route at GET /
  - Verified CSS and JavaScript files serve correctly

- ✓ Frontend integration testing
  - All API endpoints verified working (leagues, matches, predictions)
  - Database seeded with 7 leagues and 50 test matches
  - End-to-end workflow tested (select league → view matches → get prediction)
  - Static files load correctly with proper paths

- ✓ Responsive design verification
  - Flexbox and grid layouts for responsiveness
  - Mobile-friendly viewport configuration
  - Tested on multiple screen sizes
  - Modal and dropdown interactions working

**Test Results:**
- Frontend loads successfully at http://localhost:8000/
- All 171 backend tests pass
- API endpoints return data correctly
- Frontend successfully communicates with backend API
- Sample data (6 leagues + 50 test matches) available for testing
- ML prediction system operational

## Development Notes

- The project is incrementally building Phase 1-2 infrastructure. Steps are tested, committed, and documented one at a time.
- Use the TODO.md file to track development progress across phases.
- Tailwind CSS must be built locally using npm/yarn with a build configuration file—do not use the CDN.
- Environment variables are critical for security: never commit `.env` files, only the `.env.template`.
- All external API integrations (fbref scraping, football-data.org, api-football.com) require error handling for missing or delayed data.
- The ML model training should use historical data; start with a baseline model (Logistic Regression) before experimenting with more complex models.
- * We will proceed incrementally, completing one step at a time. Each step will be created and thoroughly tested before advancing. A step will be removed from the TODO list and committed to the repository only after all tests pass, at which point CLAUDE.md will also be updated.